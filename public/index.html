<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Client for Baileys Server</title>
        <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, Helvetica, Arial, sans-serif;
                background-color: #f4f7f6;
                color: #333;
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
            }
            .container {
                display: flex;
                flex-direction: column;
                gap: 30px;
            }
            .card {
                background-color: #fff;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px;
            }
            .card h2 {
                margin-top: 0;
                color: #007bff;
            }
            .form-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
            }
            label {
                font-weight: bold;
            }
            input[type="text"] {
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 1rem;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 12px 15px;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            button:hover {
                background-color: #0056b3;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            #qr-card-content {
                text-align: center;
            }
            #qr-code {
                min-height: 256px;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 20px auto;
                border: 5px solid #eee;
                padding: 10px;
                border-radius: 8px;
            }
            #refresh-qr {
                margin-top: 15px;
                background-color: #28a745;
                display: none;
            }
            #refresh-qr:hover {
                background-color: #218838;
            }
            #api-response {
                background-color: #e9ecef;
                padding: 15px;
                border-radius: 4px;
                font-family: "Courier New", Courier, monospace;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .info-box {
                background-color: #d1ecf1;
                border: 1px solid #bee5eb;
                color: #0c5460;
                padding: 15px;
                border-radius: 4px;
                margin-top: 15px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Test Client for Baileys Server ðŸš€</h1>

            <div class="card">
                <h2>1. Session Management</h2>
                <div class="form-group">
                    <label for="session-id">Session ID</label>
                    <input
                        type="text"
                        id="session-id"
                        placeholder="Ex: store-1"
                        value="my-session"
                    />
                </div>
                <div class="form-group">
                    <label for="webhook-url">Webhook URL (Optional)</label>
                    <input
                        type="text"
                        id="webhook-url"
                        placeholder="https://your-endpoint.com/webhook"
                    />
                </div>
                <button id="start-session">Start Session</button>
                <button id="stop-session" disabled>Stop Session</button>
            </div>

            <div class="card">
                <h2>2. QR Code</h2>
                <div id="qr-card-content">
                    <div id="qr-code">
                        <p>
                            The QR code will appear here after starting the
                            session.
                        </p>
                    </div>
                    <button id="refresh-qr">Refresh QR</button>
                </div>
            </div>

            <div class="card">
                <h2>3. Receive Messages (Webhooks)</h2>
                <div class="info-box">
                    <p>To test message reception:</p>
                    <ol>
                        <li>
                            Go to
                            <a href="https://webhook.site/" target="_blank"
                                >webhook.site</a
                            >
                            and copy the unique URL.
                        </li>
                        <li>Paste that URL in the "Webhook URL" field.</li>
                        <li>Start the session and scan the QR code.</li>
                        <li>
                            Send a message from another phone to the connected
                            number.
                        </li>
                        <li>
                            The message will appear on the webhook.site page.
                        </li>
                    </ol>
                </div>
            </div>

            <div id="send-message-card" class="card" style="display: none">
                <h2>4. Send Message</h2>
                <div class="form-group">
                    <label for="phone-number"
                        >Phone Number (with country code)</label
                    >
                    <input
                        type="text"
                        id="phone-number"
                        placeholder="Ex: 573001234567"
                    />
                </div>
                <div class="form-group">
                    <label for="message">Message</label>
                    <input
                        type="text"
                        id="message"
                        placeholder="Type your message here..."
                    />
                </div>
                <button id="send-message">Send Message</button>
            </div>

            <div class="card">
                <h2>API Response Log</h2>
                <pre id="api-response">
Server responses will appear here...</pre
                >
            </div>
        </div>

        <script>
            // Use current origin for API calls (works in all environments)
            const API_BASE_URL = window.location.origin;

            // Elementos del DOM
            const sessionIdInput = document.getElementById("session-id");
            const webhookUrlInput = document.getElementById("webhook-url");
            const startBtn = document.getElementById("start-session");
            const stopBtn = document.getElementById("stop-session");
            const qrCodeContainer = document.getElementById("qr-code");
            const refreshQrBtn = document.getElementById("refresh-qr");
            const sendMessageCard =
                document.getElementById("send-message-card");
            const phoneNumberInput = document.getElementById("phone-number");
            const messageInput = document.getElementById("message");
            const sendBtn = document.getElementById("send-message");
            const apiResponseLog = document.getElementById("api-response");

            let qrCodeInstance = null;

            function logResponse(data) {
                apiResponseLog.textContent = JSON.stringify(data, null, 2);
            }

            function updateUI(isSessionActive, isConnected = false) {
                sessionIdInput.disabled = isSessionActive;
                webhookUrlInput.disabled = isSessionActive;
                startBtn.disabled = isSessionActive;
                stopBtn.disabled = !isSessionActive;

                refreshQrBtn.style.display = isSessionActive
                    ? "inline-block"
                    : "none";
                sendMessageCard.style.display = isConnected ? "block" : "none";
            }

            // INICIAR SESIÃ“N
            startBtn.addEventListener("click", async () => {
                const sessionId = sessionIdInput.value;
                const webhook = webhookUrlInput.value;
                if (!sessionId) {
                    alert("Please enter a session ID.");
                    return;
                }

                qrCodeContainer.innerHTML =
                    "<p>Starting session, please wait...</p>";
                updateUI(true);

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/sessions/start`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ sessionId, webhook }),
                        }
                    );
                    const data = await response.json();
                    logResponse(data);

                    if (data.success) {
                        setTimeout(refreshQr, 2000);
                    } else {
                        qrCodeContainer.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
                        updateUI(false);
                    }
                } catch (error) {
                    qrCodeContainer.innerHTML =
                        '<p style="color: red;">Connection error with the server.</p>';
                    logResponse({ error: error.message });
                    updateUI(false);
                }
            });

            // REFRESCAR QR (LÃ“GICA ACTUALIZADA)
            async function refreshQr() {
                const sessionId = sessionIdInput.value;
                qrCodeContainer.innerHTML =
                    "<p>Refreshing QR, please wait...</p>"; // Loading message

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/sessions/${sessionId}/qr`,
                        { cache: "no-cache" }
                    );
                    const data = await response.json();
                    logResponse(data);

                    if (!data.success) {
                        qrCodeContainer.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
                        return;
                    }

                    qrCodeContainer.innerHTML = ""; // Limpiamos el contenedor antes de decidir quÃ© hacer

                    if (data.qr) {
                        // -> INICIO DE LA CORRECCIÃ“N
                        // Si la instancia ya existe, la limpiamos antes de crear una nueva.
                        // Si no, simplemente creamos la nueva. Esto asegura que siempre se renderice.
                        qrCodeInstance = null;
                        qrCodeInstance = new QRCode(qrCodeContainer, {
                            text: data.qr,
                            width: 256,
                            height: 256,
                        });
                        // -> FIN DE LA CORRECCIÃ“N
                    } else {
                        qrCodeContainer.innerHTML =
                            "<p>No QR code available.</p>";
                        qrCodeInstance = null;
                        if (data.message) {
                            alert(data.message);
                        }
                        const statusResponse = await fetch(
                            `${API_BASE_URL}/api/sessions/${sessionId}/status`
                        );
                        const statusData = await statusResponse.json();
                        if (statusData.status === "open") {
                            updateUI(true, true);
                        }
                    }
                } catch (error) {
                    console.error("Error al refrescar QR:", error);
                    qrCodeContainer.innerHTML =
                        '<p style="color: red;">Connection error when refreshing QR.</p>';
                }
            }

            refreshQrBtn.addEventListener("click", refreshQr);

            // ENVIAR MENSAJES (Sin cambios)
            sendBtn.addEventListener("click", async () => {
                const sessionId = sessionIdInput.value;
                const number = phoneNumberInput.value;
                const message = messageInput.value;

                if (!number || !message) {
                    alert("Number and message are required.");
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/sessions/${sessionId}/send-message`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ number, message }),
                        }
                    );
                    const data = await response.json();
                    logResponse(data);
                    alert(
                        data.success
                            ? "Message sent!"
                            : `Error: ${data.message}`
                    );
                    if (data.success) {
                        messageInput.value = "";
                    }
                } catch (error) {
                    logResponse({ error: error.message });
                    alert("Connection error when sending the message.");
                }
            });

            // DETENER SESIÃ“N (Sin cambios)
            stopBtn.addEventListener("click", async () => {
                const sessionId = sessionIdInput.value;
                if (
                    !confirm(
                        `Are you sure you want to stop the session "${sessionId}"?`
                    )
                )
                    return;

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/sessions/${sessionId}/end`,
                        {
                            method: "DELETE",
                        }
                    );
                    const data = await response.json();
                    logResponse(data);

                    qrCodeContainer.innerHTML =
                        "<p>The session has been stopped.</p>";
                    qrCodeInstance = null;
                    updateUI(false);
                } catch (error) {
                    logResponse({ error: error.message });
                    alert("Connection error when stopping the session.");
                }
            });
        </script>
    </body>
</html>
